<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>容器终端 - 老王出品</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/xterm/5.3.0/xterm.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Courier New', monospace;
        }

        .terminal-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .terminal-header {
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 10px 20px;
            border-bottom: 2px solid #00ff00;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .terminal-title {
            font-size: 18px;
            font-weight: bold;
            text-shadow: 0 0 10px #00ff00;
        }

        .terminal-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-connected {
            background: #00ff00;
        }

        .status-disconnected {
            background: #ff0000;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .terminal-body {
            flex: 1;
            background: #000000;
            padding: 20px;
            overflow: hidden;
        }

        #terminal {
            height: 100%;
            width: 100%;
        }

        .terminal-controls {
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            border-top: 1px solid #00ff00;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-terminal {
            background: transparent;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 5px 15px;
            border-radius: 3px;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn-terminal:hover {
            background: #00ff00;
            color: #000000;
            box-shadow: 0 0 10px #00ff00;
        }

        .terminal-info {
            color: #00ff00;
            font-size: 12px;
            margin-left: auto;
        }

        .help-text {
            color: #888;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="terminal-container">
        <!-- 终端头部 -->
        <div class="terminal-header">
            <div class="terminal-title">
                <i class="fas fa-terminal"></i> 容器终端 - 老王的黑科技
            </div>
            <div class="terminal-status">
                <div id="statusIndicator" class="status-indicator status-disconnected"></div>
                <span id="statusText">连接中...</span>
            </div>
        </div>

        <!-- 终端主体 -->
        <div class="terminal-body">
            <div id="terminal"></div>
        </div>

        <!-- 终端控制栏 -->
        <div class="terminal-controls">
            <button id="clearBtn" class="btn-terminal">
                <i class="fas fa-eraser"></i> 清屏
            </button>
            <button id="resizeBtn" class="btn-terminal">
                <i class="fas fa-expand"></i> 调整大小
            </button>
            <button id="copyBtn" class="btn-terminal">
                <i class="fas fa-copy"></i> 复制
            </button>
            <button id="pasteBtn" class="btn-terminal">
                <i class="fas fa-paste"></i> 粘贴
            </button>
            <div class="terminal-info">
                <span class="help-text">Ctrl+C: 中断 | Ctrl+D: 退出 | Ctrl+L: 清屏</span>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/5.3.0/xterm.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xterm-addon-fit/0.8.0/xterm-addon-fit.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xterm-addon-web-links/0.9.0/xterm-addon-web-links.min.js"></script>
    <script>
        class WebTerminal {
            constructor() {
                this.term = null;
                this.socket = null;
                this.fitAddon = null;
                this.isConnecting = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;

                this.initTerminal();
                this.connect();
                this.bindEvents();
            }

            initTerminal() {
                // 初始化xterm.js终端
                this.term = new Terminal({
                    cursorBlink: true,
                    cursorStyle: 'block',
                    fontFamily: '"Courier New", monospace',
                    fontSize: 14,
                    theme: {
                        background: '#000000',
                        foreground: '#00ff00',
                        cursor: '#00ff00',
                        selection: '#ffffff',
                        black: '#000000',
                        red: '#ff0000',
                        green: '#00ff00',
                        yellow: '#ffff00',
                        blue: '#0000ff',
                        magenta: '#ff00ff',
                        cyan: '#00ffff',
                        white: '#ffffff'
                    }
                });

                // 添加插件
                this.fitAddon = new FitAddon.FitAddon();
                this.term.loadAddon(this.fitAddon);

                // 绑定到DOM
                this.term.open(document.getElementById('terminal'));
                this.fitAddon.fit();

                // 欢迎信息
                this.term.writeln('\x1b[32m🔥 老王的Web Terminal启动成功！\x1b[0m');
                this.term.writeln('\x1b[32m📱 正在连接到容器终端...\x1b[0m');
                this.term.writeln('');
            }

            connect() {
                if (this.isConnecting) return;

                this.isConnecting = true;
                this.updateStatus('connecting');

                try {
                    // WebSocket连接到后端
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws/terminal`;

                    this.socket = new WebSocket(wsUrl);

                    this.socket.onopen = () => {
                        console.log('Terminal WebSocket connected');
                        this.isConnecting = false;
                        this.reconnectAttempts = 0;
                        this.updateStatus('connected');
                        this.term.writeln('\x1b[32m✅ 连接成功！可以开始输入命令了\x1b[0m');
                        this.term.writeln('');
                    };

                    this.socket.onmessage = (event) => {
                        // 接收到服务器输出
                        this.term.write(event.data);
                    };

                    this.socket.onclose = () => {
                        console.log('Terminal WebSocket disconnected');
                        this.isConnecting = false;
                        this.updateStatus('disconnected');
                        this.term.writeln('\x1b[31m❌ 连接断开\x1b[0m');

                        // 自动重连
                        if (this.reconnectAttempts < this.maxReconnectAttempts) {
                            this.reconnectAttempts++;
                            const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 10000);
                            this.term.writeln(`\x1b[33m🔄 ${delay/1000}秒后重连 (${this.reconnectAttempts}/${this.maxReconnectAttempts})\x1b[0m`);
                            setTimeout(() => this.connect(), delay);
                        } else {
                            this.term.writeln('\x1b[31m❌ 重连失败，请刷新页面\x1b[0m');
                        }
                    };

                    this.socket.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.term.writeln('\x1b[31m❌ 连接错误\x1b[0m');
                    };

                } catch (error) {
                    console.error('Connection error:', error);
                    this.isConnecting = false;
                    this.updateStatus('error');
                    this.term.writeln(`\x1b[31m❌ 连接失败: ${error.message}\x1b[0m`);
                }
            }

            updateStatus(status) {
                const indicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');

                indicator.className = 'status-indicator';

                switch (status) {
                    case 'connected':
                        indicator.classList.add('status-connected');
                        statusText.textContent = '已连接';
                        break;
                    case 'connecting':
                        indicator.style.background = '#ffff00';
                        statusText.textContent = '连接中...';
                        break;
                    case 'disconnected':
                        indicator.classList.add('status-disconnected');
                        statusText.textContent = '已断开';
                        break;
                    case 'error':
                        indicator.style.background = '#ff0000';
                        statusText.textContent = '连接错误';
                        break;
                }
            }

            bindEvents() {
                // 终端输入处理
                this.term.onData((data) => {
                    if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                        this.socket.send(data);
                    }
                });

                // 窗口大小调整
                window.addEventListener('resize', () => {
                    if (this.fitAddon) {
                        this.fitAddon.fit();
                        // 通知服务器终端大小变化
                        if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                            const { cols, rows } = this.term;
                            this.socket.send(JSON.stringify({ resize: { cols, rows } }));
                        }
                    }
                });

                // 控制按钮
                document.getElementById('clearBtn').addEventListener('click', () => {
                    this.term.clear();
                });

                document.getElementById('resizeBtn').addEventListener('click', () => {
                    this.fitAddon.fit();
                    this.term.writeln('\x1b[32m📐 终端大小已调整\x1b[0m');
                });

                document.getElementById('copyBtn').addEventListener('click', () => {
                    const selection = this.term.getSelection();
                    if (selection) {
                        navigator.clipboard.writeText(selection).then(() => {
                            this.term.writeln('\x1b[32m📋 已复制到剪贴板\x1b[0m');
                        });
                    }
                });

                document.getElementById('pasteBtn').addEventListener('click', async () => {
                    try {
                        const text = await navigator.clipboard.readText();
                        this.term.write(text);
                        if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                            this.socket.send(text);
                        }
                    } catch (error) {
                        console.error('Paste failed:', error);
                    }
                });

                // 页面关闭时断开连接
                window.addEventListener('beforeunload', () => {
                    if (this.socket) {
                        this.socket.close();
                    }
                });
            }
        }

        // 页面加载完成后初始化终端
        document.addEventListener('DOMContentLoaded', () => {
            const terminal = new WebTerminal();
        });
    </script>
</body>
</html>